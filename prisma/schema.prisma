generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String? @db.Text
  access_token             String? @db.Text
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String? @db.Text
  session_state            String?
  refresh_token_expires_in Int?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                  String    @id @default(cuid())
  name                String?
  email               String?   @unique
  emailVerified       DateTime?
  image               String?
  calendarConnected   Boolean   @default(false)
  preferences         Json?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  accounts             Account[]
  sessions             Session[]
  tasks                Task[]
  scheduledTasks       ScheduledTask[]
  feedback             Feedback[]
  learningData         LearningData[]
  progress             ProgressTracking[]
  familyMember         FamilyMember?
  externalCalendars    ExternalCalendar[]
  addinTokens          AddinToken[]
  userPreferences      UserPreference[]
  notifications        Notification[]
  weeklyPlanApprovals  WeeklyPlanApproval[]
}

model ExternalCalendar {
  id        String   @id @default(cuid())
  userId    String
  name      String   // e.g., "Work Calendar", "Personal Outlook"
  url       String   @db.Text // ICS/webcal URL
  color     String?  // Optional color for display
  isActive  Boolean  @default(true)
  lastSync  DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, url])
}

model AddinToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  name      String   @default("Outlook Add-in") // Device/app name
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Family {
  id         String   @id @default(cuid())
  name       String
  inviteCode String   @unique
  createdAt  DateTime @default(now())

  members      FamilyMember[]
  tasks        Task[]
  agentMemory  AgentMemory[]
  weeklyPlans  WeeklyPlan[]
}

model FamilyMember {
  id       String @id @default(cuid())
  familyId String
  userId   String @unique
  role     String @default("member") // "admin" or "member"

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Task {
  id         String   @id @default(cuid())
  userId     String?
  familyId   String?
  name       String
  type       String   // "resolution" or "household"
  duration   Int      // in minutes
  isFlexible Boolean  @default(true)
  category   String?
  priority   Int      @default(3) // 1-4, lower is higher priority
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user           User?           @relation(fields: [userId], references: [id], onDelete: Cascade)
  family         Family?         @relation(fields: [familyId], references: [id], onDelete: Cascade)
  scheduledTasks ScheduledTask[]
}

model ScheduledTask {
  id                  String   @id @default(cuid())
  taskId              String
  assignedToUserId    String
  scheduledDate       DateTime
  startTime           DateTime
  endTime             DateTime
  status              String   @default("pending") // "pending", "completed", "skipped"
  calendarEventId     String?  // Primary calendar (Google) event ID
  workCalendarEventId String?  // Work calendar (M365 via add-in) event ID
  aiReasoning         String?  @db.Text
  createdAt           DateTime @default(now())

  task       Task       @relation(fields: [taskId], references: [id], onDelete: Cascade)
  assignedTo User       @relation(fields: [assignedToUserId], references: [id], onDelete: Cascade)
  feedback   Feedback[]
}

model Feedback {
  id              String   @id @default(cuid())
  scheduledTaskId String
  userId          String

  // Time feedback
  actualDuration  Int?     // How long it actually took (minutes)
  timeAccuracy    String?  // "too_short", "just_right", "too_long"

  // Scheduling feedback
  timeSlotRating  Int?     // 1-5 how good was this time slot
  wouldReschedule String?  // "earlier", "later", "different_day", "no"
  preferredTime   String?  // "morning", "afternoon", "evening", "weekend"

  // Context feedback
  trafficImpact   Boolean? // Was traffic a factor?
  weatherImpact   Boolean? // Was weather a factor?
  energyLevel     String?  // "low", "medium", "high"

  // Free-form
  notes           String?  @db.Text

  createdAt       DateTime @default(now())

  scheduledTask ScheduledTask @relation(fields: [scheduledTaskId], references: [id], onDelete: Cascade)
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model LearningData {
  id                 String   @id @default(cuid())
  userId             String
  taskType           String
  taskCategory       String?
  learnedDuration    Int?
  learnedPreferences Json?
  updatedAt          DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, taskType, taskCategory])
}

model ProgressTracking {
  id             String   @id @default(cuid())
  userId         String
  weekStartDate  DateTime
  taskType       String
  completedCount Int      @default(0)
  totalCount     Int      @default(0)
  achievements   Json?
  createdAt      DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, weekStartDate, taskType])
}

// ============================================
// AI AGENT SYSTEM MODELS
// ============================================

// Store learned user preferences from feedback
model UserPreference {
  id         String   @id @default(cuid())
  userId     String
  key        String   // e.g., "preferred_gym_time", "commute_buffer", "energy_pattern"
  value      Json     // Flexible storage for different preference types
  confidence Float    @default(0.5) // 0-1, how confident the system is in this preference
  source     String   @default("inferred") // "inferred", "explicit", "default"
  updatedAt  DateTime @updatedAt
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, key])
}

// Store agent conversation context and decision history
model AgentMemory {
  id        String   @id @default(cuid())
  familyId  String
  agentType String   // "interactive", "weekly_planner", "reminder", "optimizer"
  sessionId String?  // For grouping related interactions
  context   Json     // Stored conversation/decision context
  summary   String?  @db.Text // Human-readable summary of what happened
  expiresAt DateTime
  createdAt DateTime @default(now())

  family Family @relation(fields: [familyId], references: [id], onDelete: Cascade)

  @@index([familyId, agentType])
  @@index([expiresAt])
}

// Weekly Plan - AI-generated schedule drafts for approval
model WeeklyPlan {
  id          String   @id @default(cuid())
  familyId    String
  weekStart   DateTime // Start of the week (Monday)
  weekEnd     DateTime // End of the week (Sunday)
  status      String   @default("draft") // "draft", "pending_approval", "approved", "rejected", "expired"
  aiReasoning String?  @db.Text // Why the AI made these choices
  createdBy   String   @default("system") // "system" for cron, userId for manual
  approvedBy  String?  // Deprecated: use approvals relation instead
  approvedAt  DateTime? // When fully approved (all members)
  rejectedAt  DateTime?
  expiresAt   DateTime // Auto-expire if not acted upon
  createdAt   DateTime @default(now())

  family    Family               @relation(fields: [familyId], references: [id], onDelete: Cascade)
  items     WeeklyPlanItem[]
  approvals WeeklyPlanApproval[]

  @@unique([familyId, weekStart])
  @@index([status, expiresAt])
}

// Track individual member approvals for a weekly plan
model WeeklyPlanApproval {
  id           String   @id @default(cuid())
  weeklyPlanId String
  userId       String
  status       String   @default("pending") // "pending", "approved", "rejected"
  approvedAt   DateTime?
  rejectedAt   DateTime?
  comment      String?  @db.Text // Optional feedback on the plan
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  weeklyPlan WeeklyPlan @relation(fields: [weeklyPlanId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([weeklyPlanId, userId])
  @@index([weeklyPlanId])
}

// Individual items in a weekly plan
model WeeklyPlanItem {
  id               String   @id @default(cuid())
  weeklyPlanId     String
  taskId           String
  assignedToUserId String
  scheduledDate    DateTime
  startTime        DateTime
  endTime          DateTime
  aiReasoning      String?  @db.Text // Why this specific time was chosen
  createdAt        DateTime @default(now())

  // Edit tracking for conflict detection
  version          Int      @default(1)
  lastEditedBy     String?  // userId who last edited
  lastEditedAt     DateTime?
  editHistory      Json?    // Array of previous edits for audit trail

  weeklyPlan WeeklyPlan @relation(fields: [weeklyPlanId], references: [id], onDelete: Cascade)

  @@index([weeklyPlanId])
}

// Notification queue for reminders and agent messages
model Notification {
  id           String    @id @default(cuid())
  userId       String
  type         String    // "reminder", "suggestion", "weekly_plan", "conflict", "achievement"
  title        String
  message      String    @db.Text
  actionUrl    String?   // Deep link to relevant page
  actionLabel  String?   // Button text like "View Schedule"
  priority     String    @default("normal") // "low", "normal", "high", "urgent"
  metadata     Json?     // Additional data for the notification
  scheduledFor DateTime  // When to show/send the notification
  sentAt       DateTime? // When it was actually sent
  readAt       DateTime? // When user read it
  dismissedAt  DateTime? // When user dismissed it
  createdAt    DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, scheduledFor])
  @@index([userId, readAt])
}
